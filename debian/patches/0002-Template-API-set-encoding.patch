From: Gabriel <g+gitlab@hege.cc>
Date: Wed, 19 Dec 2018 16:05:18 +0000
Subject: Set correct encoding for templates
Origin: upstream, https://gitlab.com/mailman/postorius/commit/7cc568517339c354a0b368131e87b2bea7a439e2
Bug: https://gitlab.com/mailman/postorius/issues/304

---
 .../tests/mailman_api_tests/test_template_view.py          | 7 +++++++
 src/postorius/views/template.py                            | 6 +++++-
 2 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/src/postorius/tests/mailman_api_tests/test_template_view.py b/src/postorius/tests/mailman_api_tests/test_template_view.py
index 153e8995..18d77430 100644
--- a/src/postorius/tests/mailman_api_tests/test_template_view.py
+++ b/src/postorius/tests/mailman_api_tests/test_template_view.py
@@ -22,6 +22,7 @@ import urllib
 from allauth.account.models import EmailAddress
 from django.contrib.auth.models import User
 from django.contrib.sites.models import Site
+from django.conf import settings
 from django.urls import reverse
 from django_mailman3.models import MailDomain
 
@@ -457,6 +458,9 @@ class TestTemplateAPIView(ViewTestCase):
         response = self.client.get(url)
         self.assertEqual(response.status_code, 200)
         self.assertEqual(response.content, b'This is some new data.')
+        self.assertRegex(response["Content-Type"],
+                         'charset=' + settings.DEFAULT_CHARSET)
+        self.assertNotRegex(response["Content-Type"], 'charset=$')
 
     def test_get_one_list_template_via_API(self):
         # Test that we can get a list level template from API.
@@ -478,3 +482,6 @@ class TestTemplateAPIView(ViewTestCase):
         response = self.client.get(url)
         self.assertEqual(response.status_code, 200)
         self.assertEqual(response.content, b'This is some other new data.')
+        self.assertRegex(response["Content-Type"],
+                         'charset=' + settings.DEFAULT_CHARSET)
+        self.assertNotRegex(response["Content-Type"], 'charset=$')
diff --git a/src/postorius/views/template.py b/src/postorius/views/template.py
index c3542760..a9730fd3 100644
--- a/src/postorius/views/template.py
+++ b/src/postorius/views/template.py
@@ -19,6 +19,7 @@
 
 from django.core.exceptions import MultipleObjectsReturned
 from django.db import IntegrityError
+from django.conf import settings
 from django.http import Http404, HttpResponseBadRequest, HttpResponse
 from django.shortcuts import redirect
 from django.urls import reverse_lazy
@@ -190,5 +191,8 @@ def get_template_data(request, context, identifier, name):
     except MultipleObjectsReturned:
         raise HttpResponseBadRequest('Multiple Templates exist')
 
+    content_type = 'text/plain'
+    if settings.DEFAULT_CHARSET:
+        content_type += '; charset=' + settings.DEFAULT_CHARSET
     return HttpResponse(template.data,
-                        content_type='text/plain')
+                        content_type=content_type)
-- 
2.18.1

